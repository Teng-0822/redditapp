<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BEAST MODE</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<style>
:root { 
  --bg-primary: #0a0a0a;
  --bg-secondary: #141414;
  --bg-card: #1a1a1a;
  --bg-elevated: #222;
  --accent-primary: #ff3366;
  --accent-secondary: #00ffaa;
  --accent-orange: #ff9500;
  --border-subtle: #2a2a2a;
  --border-normal: #333;
  --text-primary: #ffffff;
  --text-secondary: #aaa;
  --text-muted: #666;
  --success: #2e7d32;
  --error: #d32f2f;
  --warning: #ff9500;
}

* { margin:0; padding:0; box-sizing:border-box; }

body { 
  background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%); 
  color: var(--text-primary); 
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; 
  min-height: 100vh; 
  padding: 16px 16px 140px 16px;
  overflow-x: hidden;
  line-height: 1.5;
}

.header {
  text-align: center;
  margin-bottom: 24px;
}

h1 { 
  font-size: clamp(1.8rem, 5vw, 2.5rem);
  background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary)); 
  -webkit-background-clip: text; 
  -webkit-text-fill-color: transparent; 
  background-clip: text;
  margin-bottom: 8px;
  font-weight: 800;
  letter-spacing: 2px;
}

.subtitle {
  color: var(--text-secondary);
  font-size: 0.9rem;
  font-weight: 500;
}

.ip-control {
  background: var(--bg-card);
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 20px;
  max-width: 600px;
  margin-left: auto;
  margin-right: auto;
  border: 1px solid var(--border-normal);
}

.ip-input-row {
  display: grid;
  grid-template-columns: minmax(60px, 100px) 1fr;
  gap: 12px;
  margin-bottom: 12px;
}

.ip-stats-row {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}

.stat-box {
  background: var(--bg-secondary);
  padding: 10px;
  border-radius: 10px;
  text-align: center;
  border: 2px solid;
}

.stat-box.posts { border-color: var(--accent-orange); }
.stat-box.filtered { border-color: var(--error); }

.stat-label {
  font-size: 0.7rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 2px;
}

.stat-value {
  font-size: 1.3rem;
  font-weight: 700;
}

.stat-box.posts .stat-value { color: var(--accent-orange); }
.stat-box.filtered .stat-value { color: var(--error); }

.input, .select, .textarea {
  width: 100%;
  padding: 12px 14px;
  border-radius: 10px;
  background: var(--bg-secondary);
  border: 2px solid var(--border-normal);
  color: var(--text-primary);
  font-size: 0.95rem;
  font-weight: 500;
  outline: none;
  transition: all 0.2s;
  font-family: inherit;
}

.input:focus, .select:focus, .textarea:focus {
  border-color: var(--accent-orange);
  background: var(--bg-elevated);
}

.input:read-only {
  opacity: 0.6;
  cursor: not-allowed;
}

.btn {
  padding: 12px 20px;
  border-radius: 10px;
  border: none;
  font-weight: 600;
  font-size: 0.95rem;
  cursor: pointer;
  transition: all 0.2s;
  outline: none;
  font-family: inherit;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.btn:active { transform: scale(0.96); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }

.btn-primary {
  background: var(--accent-orange);
  color: #000;
  font-weight: 700;
}

.btn-primary:hover:not(:disabled) {
  background: #ffaa33;
}

.btn-secondary {
  background: var(--bg-elevated);
  color: var(--text-primary);
  border: 1px solid var(--border-normal);
}

.btn-secondary:hover:not(:disabled) {
  background: var(--bg-card);
  border-color: var(--accent-orange);
}

.btn-sm {
  padding: 8px 14px;
  font-size: 0.85rem;
}

.btn-toggle {
  background: var(--accent-orange);
  color: #000;
}

.btn-toggle.active {
  background: #000;
  color: var(--accent-orange);
  border: 2px solid var(--accent-orange);
}

.card {
  background: var(--bg-card);
  border-radius: 16px;
  margin-bottom: 16px;
  max-width: 600px;
  margin-left: auto;
  margin-right: auto;
  border: 1px solid var(--border-normal);
  overflow: hidden;
  transition: border-color 0.3s;
}

.card:hover {
  border-color: var(--border-subtle);
}

.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 18px;
  background: rgba(255,255,255,0.02);
  cursor: pointer;
  user-select: none;
}

.card-header:hover {
  background: rgba(255,255,255,0.04);
}

.card-title-wrapper {
  display: flex;
  align-items: center;
  gap: 10px;
  flex: 1;
}

.card-icon {
  font-size: 1.3rem;
}

.card-title {
  font-size: 1.1rem;
  font-weight: 700;
}

.card-badge {
  display: inline-flex;
  align-items: center;
  background: var(--accent-orange);
  color: #000;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 700;
}

.expand-icon {
  font-size: 20px;
  color: var(--text-muted);
  transition: transform 0.3s ease;
}

.expand-icon.open { 
  transform: rotate(180deg); 
}

.card-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), padding 0.4s;
}

.card-content.open {
  max-height: 1000px;
  padding: 18px;
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 10px;
  margin-bottom: 12px;
}

.form-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.form-actions > * {
  flex: 1;
  min-width: 120px;
}

.stats-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 14px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border-normal);
}

.stats-text {
  font-size: 0.95rem;
  color: var(--text-secondary);
}

.stats-number {
  font-weight: 700;
  color: var(--accent-orange);
}

.stats-actions {
  display: flex;
  gap: 6px;
}

.list-container {
  max-height: 320px;
  overflow-y: auto;
  padding: 10px;
  background: var(--bg-secondary);
  border-radius: 10px;
  border: 1px solid var(--border-normal);
  margin-top: 12px;
}

.list-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 14px;
  background: var(--bg-elevated);
  margin-bottom: 8px;
  border-radius: 8px;
  transition: all 0.2s;
}

.list-item:last-child {
  margin-bottom: 0;
}

.list-item:hover {
  background: var(--bg-card);
}

.list-item.checked {
  opacity: 0.4;
  text-decoration: line-through;
}

.list-item input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: var(--accent-orange);
}

.list-item-text {
  flex: 1;
  font-size: 0.95rem;
  color: var(--text-primary);
  word-break: break-word;
}

.list-item-delete {
  background: none;
  border: none;
  color: var(--error);
  font-size: 22px;
  font-weight: bold;
  cursor: pointer;
  padding: 4px 8px;
  opacity: 0.7;
  transition: opacity 0.2s;
}

.list-item-delete:hover {
  opacity: 1;
}

.ip-display {
  background: var(--bg-secondary);
  border-radius: 12px;
  padding: 18px;
  border: 2px solid var(--border-normal);
  margin-top: 14px;
}

.ip-row {
  margin-bottom: 16px;
  text-align: center;
}

.ip-row:last-child {
  margin-bottom: 0;
}

.ip-label {
  font-size: 0.75rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
}

.ip-value {
  font-size: 1.2rem;
  font-weight: 700;
  color: var(--accent-orange);
  font-family: 'Courier New', monospace;
}

.ip-location {
  font-size: 0.9rem;
  color: var(--text-secondary);
  margin-top: 4px;
}

.rotate-section {
  display: flex;
  gap: 10px;
  margin-bottom: 14px;
}

.rotate-section .btn {
  min-width: 80px;
}

.fab-container {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
  max-width: 95vw;
}

.fab-bar {
  display: flex;
  gap: 10px;
  background: rgba(20, 20, 20, 0.98);
  padding: 12px 16px;
  border-radius: 50px;
  backdrop-filter: blur(20px);
  border: 1px solid var(--border-normal);
  box-shadow: 0 10px 40px rgba(0,0,0,0.8);
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.fab {
  width: 54px;
  height: 54px;
  min-width: 54px;
  border-radius: 50%;
  background: var(--accent-orange);
  color: #000;
  font-size: 16px;
  font-weight: 700;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  box-shadow: 0 4px 12px rgba(255, 149, 0, 0.3);
}

.fab:active {
  transform: scale(0.9);
}

.fab:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.fab:hover:not(:disabled) {
  transform: scale(1.05);
  box-shadow: 0 6px 20px rgba(255, 149, 0, 0.5);
}

.toast {
  position: fixed;
  bottom: 100px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--accent-orange);
  color: #000;
  padding: 12px 24px;
  border-radius: 30px;
  font-weight: 700;
  font-size: 0.9rem;
  z-index: 10000;
  opacity: 0;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  pointer-events: none;
  max-width: 90vw;
  text-align: center;
  box-shadow: 0 8px 20px rgba(0,0,0,0.5);
}

.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

.hidden {
  display: none !important;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: var(--bg-primary);
  z-index: 10001;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.modal.show {
  display: block;
}

.modal-content {
  max-width: 600px;
  margin: 0 auto;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  padding: 0;
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px;
  border-bottom: 2px solid var(--border-normal);
  background: var(--bg-card);
  position: sticky;
  top: 0;
  z-index: 100;
}

.modal-header h2 {
  font-size: clamp(1.3rem, 5vw, 1.6rem);
  margin: 0;
  display: flex;
  align-items: center;
  gap: 10px;
  color: var(--text-primary);
  font-weight: 700;
}

.modal-close {
  background: var(--bg-elevated);
  border: 2px solid var(--border-normal);
  color: var(--text-primary);
  font-size: 1.8rem;
  cursor: pointer;
  padding: 0;
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 12px;
  transition: all 0.2s;
  font-weight: 300;
}

.modal-close:hover {
  background: var(--error);
  border-color: var(--error);
  transform: scale(1.05);
}

.modal-close:active {
  transform: scale(0.95);
}

/* Header Stats in Modal */
.header-stats {
  display: flex;
  gap: 12px;
  margin-left: auto;
  margin-right: 12px;
}

.header-stat {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 6px 12px;
  border-radius: 8px;
  background: var(--bg-secondary);
  border: 2px solid;
  min-width: 55px;
}

.header-stat.posts {
  border-color: var(--accent-orange);
}

.header-stat.filtered {
  border-color: var(--error);
}

.header-stat-value {
  font-size: 1.1rem;
  font-weight: 700;
  line-height: 1;
}

.header-stat.posts .header-stat-value {
  color: var(--accent-orange);
}

.header-stat.filtered .header-stat-value {
  color: var(--error);
}

.header-stat-label {
  font-size: 0.6rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.3px;
  margin-top: 2px;
}

/* Filter Button */
.header-filter-btn {
  background: var(--bg-elevated);
  border: 2px solid var(--border-normal);
  color: var(--text-primary);
  font-size: 1.1rem;
  cursor: pointer;
  padding: 0;
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 12px;
  transition: all 0.2s;
  font-weight: 600;
  margin-left: 6px;
}

.header-filter-btn:hover {
  background: var(--accent-orange);
  border-color: var(--accent-orange);
  color: #000;
  transform: scale(1.05);
}

.header-filter-btn:active {
  transform: scale(0.95);
}

.modal-body {
  padding: 20px;
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 16px;
  background: var(--bg-primary);
}

.modal-body .input {
  padding: 14px 16px;
  border-radius: 12px;
  background: var(--bg-card);
  border: 2px solid var(--border-normal);
  font-size: 1rem;
  min-height: 50px;
}

.modal-body .input:focus {
  border-color: var(--accent-orange);
  background: var(--bg-elevated);
  box-shadow: 0 0 0 3px rgba(255, 149, 0, 0.1);
}

.modal-body .btn {
  padding: 12px 16px;
  border-radius: 12px;
  border: 2px solid var(--border-normal);
  background: var(--bg-card);
  min-height: 50px;
}

.modal-body .btn:hover:not(:disabled) {
  border-color: var(--accent-orange);
  background: var(--bg-elevated);
}

.modal-body .btn-primary {
  background: var(--accent-orange);
  border-color: var(--accent-orange);
}

.modal-body .btn-primary:hover:not(:disabled) {
  background: #ffaa33;
  border-color: #ffaa33;
  box-shadow: 0 4px 12px rgba(255, 149, 0, 0.3);
}

.profile-row {
  display: grid;
  grid-template-columns: 1fr auto auto;
  gap: 10px;
  align-items: stretch;
}

.profile-row .btn {
  min-width: 70px;
}

.profile-actions {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-top: 8px;
}

.btn-save {
  width: 100%;
  min-height: 56px;
  font-size: 1.05rem;
  margin-top: 16px;
}

/* Reddit Code Fetcher Styles */
.code-fetcher-section {
  background: var(--bg-secondary);
  border-radius: 12px;
  padding: 14px;
  border: 2px solid #FF4500;
  margin-bottom: 12px;
}

.code-fetcher-title {
  font-size: 0.8rem;
  color: #FF4500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 10px;
  text-align: center;
  font-weight: 600;
}

.code-fetcher-row {
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 10px;
  align-items: center;
}

.code-get-btn {
  background-color: #FF4500 !important;
  color: white !important;
  border: none !important;
  padding: 10px 16px !important;
  font-size: 14px !important;
  border-radius: 8px !important;
  cursor: pointer;
  transition: all 0.3s;
  min-width: 70px;
}

.code-get-btn:hover:not(:disabled) {
  background-color: #cc3700 !important;
}

.code-get-btn:disabled {
  background-color: #666 !important;
  cursor: not-allowed;
}

.code-display-btn {
  background-color: #dc3545 !important;
  color: white !important;
  border: none !important;
  padding: 12px 16px !important;
  font-size: 1.2rem !important;
  font-weight: bold !important;
  letter-spacing: 2px;
  border-radius: 8px !important;
  cursor: pointer;
  transition: all 0.3s;
  text-align: center;
}

.code-display-btn.has-code {
  background-color: #28a745 !important;
}

.code-display-btn.has-code:hover {
  background-color: #218838 !important;
}

/* Profile Filter Modal Styles */
.filter-list-container {
  max-height: 60vh;
  overflow-y: auto;
  padding: 10px;
  background: var(--bg-secondary);
  border-radius: 10px;
  border: 1px solid var(--border-normal);
}

.filter-profile-item {
  display: grid;
  grid-template-columns: auto 1fr auto;
  gap: 12px;
  padding: 14px;
  background: var(--bg-elevated);
  margin-bottom: 8px;
  border-radius: 8px;
  transition: all 0.2s;
  cursor: pointer;
  align-items: center;
}

.filter-profile-item:hover {
  background: var(--bg-card);
  border: 2px solid var(--accent-orange);
  padding: 12px;
}

.filter-profile-item.selected {
  background: var(--accent-orange);
  color: #000;
}

.filter-profile-item.selected .filter-profile-text {
  color: #000;
}

.filter-profile-number {
  font-size: 1.2rem;
  font-weight: 700;
  color: var(--accent-orange);
  min-width: 40px;
  text-align: center;
}

.filter-profile-item.selected .filter-profile-number {
  color: #000;
}

.filter-profile-text {
  flex: 1;
  font-size: 0.95rem;
  color: var(--text-primary);
}

.filter-profile-username {
  font-weight: 600;
  margin-bottom: 2px;
}

.filter-profile-email {
  font-size: 0.85rem;
  color: var(--text-secondary);
}

.filter-profile-item.selected .filter-profile-email {
  color: rgba(0, 0, 0, 0.7);
}

.filter-profile-status {
  font-size: 1.5rem;
}

::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--bg-secondary);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: var(--accent-orange);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #ffaa33;
}

.text-center {
  text-align: center;
}

.mt-1 { margin-top: 8px; }
.mt-2 { margin-top: 12px; }
.mt-3 { margin-top: 16px; }
.mb-1 { margin-bottom: 8px; }
.mb-2 { margin-bottom: 12px; }
.mb-3 { margin-bottom: 16px; }

@media (max-width: 500px) {
  .modal-header {
    padding: 16px;
  }
  
  .modal-body {
    padding: 16px;
    gap: 14px;
  }
  
  .profile-row .btn {
    min-width: 60px;
    font-size: 0.9rem;
    padding: 10px 12px;
  }
  
  .modal-body .input {
    font-size: 0.95rem;
    padding: 12px 14px;
  }
  
  .header-filter-btn {
    width: 40px;
    height: 40px;
    font-size: 1rem;
  }
}

@media (max-width: 480px) {
  body {
    padding: 12px 12px 140px 12px;
  }

  .ip-input-row {
    grid-template-columns: minmax(50px, 80px) 1fr;
    gap: 8px;
  }

  .form-grid {
    grid-template-columns: 1fr;
  }

  .fab {
    width: 50px;
    height: 50px;
    min-width: 50px;
    font-size: 14px;
  }

  .fab-bar {
    gap: 8px;
    padding: 10px 14px;
  }
}

@media (max-width: 380px) {
  .profile-row .btn {
    min-width: 50px;
    font-size: 0.85rem;
    padding: 10px 8px;
  }
  
  .header-stat {
    min-width: 50px;
    padding: 5px 10px;
  }
}

@media (max-width: 360px) {
  h1 {
    font-size: 1.6rem;
    letter-spacing: 1px;
  }

  .card-title {
    font-size: 1rem;
  }

  .fab {
    width: 46px;
    height: 46px;
    min-width: 46px;
    font-size: 13px;
  }
}
</style>
</head>
<body>



<div class="ip-control">
  <div class="ip-input-row">
    <input type="text" id="ipInput" placeholder="IP" value="1" maxlength="16" class="input">
    <button id="ipToggle" class="btn btn-toggle">192.168.1.x</button>
  </div>
</div>

<div class="card">
  <div class="card-header" onclick="openProfileModal()">
    <div class="card-title-wrapper">
      <span class="card-icon">üë§</span>
      <span class="card-title">Profile</span>
    </div>
    <span class="expand-icon">‚ñ∂</span>
  </div>
</div>

<div class="modal" id="profileModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>üë§ Profile</h2>
      <div class="header-stats">
        <div class="header-stat posts">
          <span class="header-stat-value" id="postCount">0</span>
          <span class="header-stat-label">Active</span>
        </div>
        <div class="header-stat filtered">
          <span class="header-stat-value" id="filteredCount">0</span>
          <span class="header-stat-label">Filtered</span>
        </div>
      </div>
      <button class="header-filter-btn" onclick="openFilterModal()">F</button>
      <button class="modal-close" onclick="closeProfileModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="profile-row">
        <input type="text" id="profileName" placeholder="Email" readonly class="input">
        <button onclick="copyText('profileName'); triggerLua()" class="btn">üìß</button>
        <button onclick="randomNoRepeat(dmTexts, dmUsed)" class="btn">D</button>
      </div>
      
      <div class="profile-row">
        <input type="text" id="profileUser" placeholder="Username" class="input">
        <button onclick="copyText('profileUser')" class="btn">üë§</button>
        <button onclick="randomNoRepeat(names, nameUsed)" class="btn">N</button>
      </div>
      
      <div class="profile-row">
        <input type="text" id="profilePass" placeholder="Password" class="input">
        <button onclick="copyText('profilePass'); triggerLua()" class="btn">üîë</button>
        <button onclick="randomNoRepeat(ofLines, ofUsed)" class="btn">OF</button>
      </div>
      
      <div class="profile-row">
        <input type="text" id="profileID" placeholder="ID" readonly class="input">
        <!--<button onclick="copyText('profileID')" class="btn">üÜî</button>-->
        <button onclick="openRandomSub()" class="btn" title="Random">R</button>
        <button onclick="if(linkUrls.length===0)return showToast('‚ö†Ô∏è No links available');const link=linkUrls[Math.floor(Math.random()*linkUrls.length)];navigator.clipboard.writeText(link);showToast('üîó Link copied'); triggerLua();" class="btn">üîó</button>
      </div>
      
      <div class="profile-actions">
        <button onclick="generatePassword(); triggerLua()" class="btn">üé≤ Gen</button>
        <button onclick="pasteUsername()" class="btn">üìã Paste</button>
        <button onclick="comboSAPFromModal()" class="btn">SAP</button>
      </div>
      
      <div class="profile-actions">
        <button onclick="prevProfile()" class="btn">‚óÄ Prev</button>
        <button onclick="const currentID=document.getElementById('profileID').value.trim();if(!currentID){showToast('‚ö†Ô∏è No ID loaded');return;}navigator.clipboard.writeText(currentID);window.location.href='shortcuts://run-shortcut?name=CreateRed';showToast('üöÄ ID copied ‚Üí CreateRed launched');" class="btn">+</button>
        <button onclick="nextProfile()" class="btn">Next ‚ñ∂</button>
      </div>
      
      <button id="saveProfileBtn" onclick="saveProfile()" class="btn btn-primary btn-save">üíæ Save Profile</button>
      
      <!-- Reddit Code Fetcher Section -->
      <div class="code-fetcher-section">
        <div class="code-fetcher-title">üîê Reddit Verification Code</div>
        <div class="code-fetcher-row">
          <button id="codeGetBtn" class="code-get-btn" onclick="fetchRedditCode()">Get</button>
          <button id="codeDisplayBtn" class="code-display-btn" onclick="copyRedditCode()">No Code</button>
        </div>
      </div>
      
      </div>
  </div>
</div>

<!-- Profile Filter Modal -->
<div class="modal" id="filterModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>üîç Select Profile</h2>
      <button class="modal-close" onclick="closeFilterModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="filter-list-container" id="filterList"></div>
    </div>
  </div>
</div>


<div class="card">
  <div class="card-header" onclick="toggleCard('sub')">
    <div class="card-title-wrapper">
      <span class="card-icon">üìç</span>
      <span class="card-title">SubReddit</span>
      <span class="card-badge" id="subBadge">0/0</span>
    </div>
    <span class="expand-icon" id="subIcon">‚ñº</span>
  </div>
  <div class="card-content" id="subContent">
    <select id="locationSelect" class="select mb-2"></select>
    <div class="stats-header">
      <span class="stats-text">
        Done <span class="stats-number" id="subDone">0</span> / <span class="stats-number" id="subCount">0</span>
      </span>
      <div class="stats-actions">
        <button id="subrReset" class="btn btn-secondary btn-sm">Reset</button>
        <button id="addSubBtn" class="btn btn-secondary btn-sm">+ Add</button>
      </div>
    </div>
    <div class="form-actions">
      <button id="subRefresh" class="btn btn-secondary">üîÑ Refresh</button>
      <button class="btn btn-secondary" id="toggleSub">üìã List</button>
    </div>
    <div class="list-container hidden" id="subList"></div>
  </div>
</div>

<div class="card">
  <div class="card-header" onclick="toggleCard('test')">
    <div class="card-title-wrapper">
      <span class="card-icon">üß™</span>
      <span class="card-title">Test Subs</span>
      <span class="card-badge" id="testBadge">0/0</span>
    </div>
    <span class="expand-icon" id="testIcon">‚ñº</span>
  </div>
  <div class="card-content" id="testContent">
    <div class="stats-header">
      <span class="stats-text">
        Done <span class="stats-number" id="testDone">0</span> / <span class="stats-number" id="testCount">0</span>
      </span>
      <div class="stats-actions">
        <button id="testReset" class="btn btn-secondary btn-sm">Reset</button>
        <button id="addTestBtn" class="btn btn-secondary btn-sm">+ Add</button>
      </div>
    </div>
    <div class="form-actions">
      <button onclick="loadFromSheet()" class="btn btn-secondary">üîÑ Refresh</button>
      <button class="btn btn-secondary" id="toggleTest">üìã List</button>
    </div>
    <div class="list-container hidden" id="testList"></div>
  </div>
</div>

<div class="card">
  <div class="card-header" onclick="toggleCard('cap')">
    <div class="card-title-wrapper">
      <span class="card-icon">üí¨</span>
      <span class="card-title">Caption</span>
      <span class="card-badge" id="capBadge">0/0</span>
    </div>
    <span class="expand-icon" id="capIcon">‚ñº</span>
  </div>
  <div class="card-content" id="capContent">
    <div class="stats-header">
      <span class="stats-text">
        Used <span class="stats-number" id="capUsed">0</span> / <span class="stats-number" id="capCount">0</span>
      </span>
      <div class="stats-actions">
        <button id="captionReset" class="btn btn-secondary btn-sm">Reset</button>
        <button id="addCapBtn" class="btn btn-secondary btn-sm">+ Add</button>
      </div>
    </div>
    <div class="form-actions">
      <button onclick="updateCaptionsNow()" class="btn btn-secondary">üîÑ Refresh</button>
      <button class="btn btn-secondary" id="toggleCap">üìã List</button>
    </div>
    <div class="list-container hidden" id="captionList"></div>
  </div>
</div>

<div class="card">
  <div class="card-header" onclick="toggleCard('ip')">
    <div class="card-title-wrapper">
      <span class="card-icon">üåê</span>
      <span class="card-title" id="ipHeader">Loading IP...</span>
    </div>
    <span class="expand-icon" id="ipIcon">‚ñº</span>
  </div>
  <div class="card-content" id="ipContent">
    <div class="rotate-section">
      <button class="btn btn-primary" onclick="rotateIP()">üîÑ Rotate</button>
      <input id="rotateLink" placeholder="http://87.120..." class="input" />
    </div>
    <div class="ip-display">
      <div class="ip-row">
        <div class="ip-label">Previous IP</div>
        <div class="ip-value" id="oldIP">‚Äî</div>
      </div>
      <div class="ip-row">
        <div class="ip-label">Current IP</div>
        <div class="ip-value" id="ip">Loading...</div>
        <div class="ip-location" id="ipLocation">‚Äî</div>
      </div>
      <button onclick="refreshAndOpen()" class="btn btn-primary mt-2" style="width: 100%;">üîç Check IP & Open Scamalytics</button>
    </div>
  </div>
</div>

<div class="fab-container">
  <div class="fab-bar">
    <button class="fab" id="fabD" title="DM">D</button>
    <button class="fab" id="fabN" title="Name">N</button>
    <button class="fab" id="fabOF" title="OF">OF</button>
    <button class="fab" id="fabLink" title="Link">üîó</button>
    <button class="fab" id="comboFab" title="SAP">SAP</button>
    <button class="fab" id="testComboFab" title="Test">Tes</button>
    <button class="fab" id="randomSubBtn" title="Random">R</button>
    <button class="fab" id="fabUrl" title="URL">url</button>
    <button class="fab" id="fabCreate" title="Create">+</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let SHEET_URL = localStorage.getItem('sheetURL') || "https://script.google.com/macros/s/AKfycbxpQMnseG33iUwT29cDvXG7sb2S5ojiYJNitfVfcVHjF4ndfDkv_Ckqly6PcHGB9ogHGQ/exec";
let PROFILE_URL = SHEET_URL;

// Reddit Code Fetcher - REPLACE THIS WITH YOUR GOOGLE APPS SCRIPT WEB APP URL
const CODE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwZRdlTV5Jn6NTmRmTfYmdiBFZwpoaOMmf19890weS1RCW7BQqQxF_jV9wxS1cnQ54R/exec';
let currentRedditCode = '';

async function fetchRedditCode() {
  const getBtn = document.getElementById('codeGetBtn');
  const codeBtn = document.getElementById('codeDisplayBtn');
  
  getBtn.disabled = true;
  getBtn.textContent = 'Fetching...';
  
  try {
    const response = await fetch(CODE_SCRIPT_URL);
    const data = await response.json();
    
    currentRedditCode = data.code;
    
    // Check if we got a valid code (6 digits)
    if (/^\d{6}$/.test(currentRedditCode)) {
      codeBtn.textContent = currentRedditCode;
      codeBtn.classList.add('has-code');
      showToast('‚úÖ Code fetched!');
    } else {
      codeBtn.textContent = currentRedditCode;
      codeBtn.classList.remove('has-code');
    }
    
  } catch (error) {
    codeBtn.textContent = 'Error';
    codeBtn.classList.remove('has-code');
    console.error('Error:', error);
    showToast('‚ùå Failed to fetch code');
  } finally {
    getBtn.disabled = false;
    getBtn.textContent = 'Get';
  }
}

function copyRedditCode() {
  // Only copy if we have a valid code
  if (/^\d{6}$/.test(currentRedditCode)) {
    navigator.clipboard.writeText(currentRedditCode).then(() => {
      showToast('‚úì Code copied to clipboard!');
    }).catch(err => {
      showToast('Failed to copy');
      console.error('Copy failed:', err);
    });
  }
}

let locations = {};
let currentLocation = localStorage.getItem('currentLocation') || '';
let subs = [];
let testSubs = [];
let captions = [];
let randomSubList = [];

let subChecked = JSON.parse(localStorage.getItem('subCh3') || '{}');
let testChecked = JSON.parse(localStorage.getItem('testCh3') || '{}');
let subIndex = parseInt(localStorage.getItem('subIdx3') || '0');
let testIndex = parseInt(localStorage.getItem('testIdx3') || '0');
let capUsed = JSON.parse(localStorage.getItem('capUs3') || '{}');
let dmUsed = JSON.parse(localStorage.getItem('dmUsed') || '{}');
let nameUsed = JSON.parse(localStorage.getItem('nameUsed') || '{}');
let ofUsed = JSON.parse(localStorage.getItem('ofUsed') || '{}');

let dmTexts = [];
let names = [];
let ofLines = [];
let linkUrls = [];

let usernameCheckInterval = null;

async function checkRedditUsername(username) {
  if (!username || username.trim() === '') return 'empty';
  const cleanUsername = username.trim();
  
  try {
    const response = await fetch(`https://www.reddit.com/user/${cleanUsername}.json`, {
      method: 'GET',
      headers: { 'Accept': 'application/json' }
    });
    const text = await response.text();
    
    try {
      const data = JSON.parse(text);
      if (data.error === 404 || data.message === 'Not Found') return 'notfound';
      if (data && data.data && data.data.children) return 'active';
      
      if (data && data.data && !data.data.children) {
        const aboutResponse = await fetch(`https://www.reddit.com/user/${cleanUsername}/about.json`);
        const aboutData = await aboutResponse.json();
        if (aboutData && aboutData.data && aboutData.data.is_suspended) return 'banned';
        if (aboutData && aboutData.data && aboutData.data.name) return 'active';
        return 'banned';
      }
      return 'banned';
    } catch (parseError) {
      if (text.includes('banned') || text.includes('suspended') || text.includes('This account has been')) return 'banned';
      if (text.includes('nobody on Reddit goes by that name') || text.includes('page not found')) return 'notfound';
      return 'error';
    }
  } catch (error) {
    console.error('Error checking username:', error);
    return await checkViaIframe(cleanUsername);
  }
}

function openProfileModal() {
  document.getElementById('profileModal').classList.add('show');
}

function closeProfileModal() {
  document.getElementById('profileModal').classList.remove('show');
}

function openFilterModal() {
  renderFilterList();
  document.getElementById('filterModal').classList.add('show');
}

function closeFilterModal() {
  document.getElementById('filterModal').classList.remove('show');
}

function renderFilterList() {
  const container = document.getElementById('filterList');
  container.innerHTML = '';
  
  if (profileData.length === 0) {
    container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No profiles available</div>';
    return;
  }
  
  profileData.forEach((row, index) => {
    const div = document.createElement('div');
    div.className = 'filter-profile-item' + (index === currentIndex ? ' selected' : '');
    
    const number = document.createElement('div');
    number.className = 'filter-profile-number';
    number.textContent = (index + 1).toString();
    
    const textContainer = document.createElement('div');
    textContainer.className = 'filter-profile-text';
    
    const username = document.createElement('div');
    username.className = 'filter-profile-username';
    username.textContent = row[2] || 'No username';
    
    const email = document.createElement('div');
    email.className = 'filter-profile-email';
    email.textContent = row[0] || 'No email';
    
    textContainer.appendChild(username);
    textContainer.appendChild(email);
    
    const status = document.createElement('div');
    status.className = 'filter-profile-status';
    status.textContent = index === currentIndex ? '‚úì' : '';
    
    div.appendChild(number);
    div.appendChild(textContainer);
    div.appendChild(status);
    
    div.onclick = () => {
      loadProfile(index);
      closeFilterModal();
      showToast(`üë§ Profile ${index + 1} loaded`);
    };
    
    container.appendChild(div);
  });
}

function openRandomSub() {
  if (randomSubList.length === 0) return showToast("‚ö†Ô∏è No warming subs");
  const random = randomSubList[Math.floor(Math.random() * randomSubList.length)];
  const appUrl = "reddit://reddit.com/r/" + random;
  
  window.location.href = appUrl;
  showToast("üé≤ Opening r/" + random);
}
document.getElementById('randomSubBtn').onclick = () => openRandomSub();
//=============================================================================Start Combo SAP====================================================================
async function comboSAPFromModal() {
  if (!currentLocation || subs.length === 0) {
    showToast("‚ö†Ô∏è Select a location with subs!");
    return;
  }
  
  let sub = ''; 
  let startIndex = subIndex;
  do { 
    sub = subs[subIndex]; 
    if (!subChecked[sub]) break; 
    subIndex = (subIndex + 1) % subs.length; 
  } while (subIndex !== startIndex);
  
  if (subChecked[sub]) { 
    subChecked = {}; 
    subIndex = 0; 
    save(); 
    showToast("üîÑ All used in " + currentLocation + " ‚Üí Reset!"); 
  }
  
  subChecked[sub] = true; 
  subIndex = (subIndex + 1) % subs.length; 
  save();
  
  // Fetch caption from the subreddit (top 20 posts, under 25 chars)
  let caption = await fetchRandomCaption(sub, 20, 25);
  
  // Fallback to local captions if fetch fails
  if (!caption) {
    showToast("‚ö†Ô∏è Fetch failed, using local caption");
    const unusedCaps = captions.filter(c => !capUsed[c]);
    if (unusedCaps.length === 0) { 
      capUsed = {}; 
      save(); 
    }
    caption = unusedCaps.length ? unusedCaps[Math.floor(Math.random() * unusedCaps.length)] : captions[Math.floor(Math.random() * captions.length)];
    capUsed[caption] = true; 
    save();
  }
  
  // Transform caption
  caption = transformCaption(caption);
  
  const encodedTitle = encodeURIComponent(caption.trim());
  window.location.href = `reddit://r/${sub}/submit?title=${encodedTitle}`;
  //const redditUrl = `https://www.reddit.com/r/${sub}/submit?title=${encodedTitle}`;
  //window.location.href = redditUrl;
  
  render('subList', subs, subChecked); 
  render('captionList', captions, capUsed); 
  updateStats();
  navigator.clipboard.writeText(sub); 
  showToast(`üöÄ SAP ‚Üí r/${sub} (${currentLocation})`);
}

function transformCaption(caption) {
  let transformed = caption;
  
  // Replace m4f, mf4mf, f4f with f4m (case insensitive)
  transformed = transformed.replace(/\bm4f\b/gi, 'f4m');
  transformed = transformed.replace(/\bmf4mf\b/gi, 'f4m');
  transformed = transformed.replace(/\bf4f\b/gi, 'f4m');
  
  // Replace f(age) or m(age) with f18 (e.g., f29 ‚Üí f18, m25 ‚Üí f18)
  transformed = transformed.replace(/\b[fm]\d+\b/gi, 'f18');
  
  // Replace (age)f or (age)m with 18f (e.g., 29f ‚Üí 18f, 25m ‚Üí 18f)
  transformed = transformed.replace(/\b\d+[fm]\b/gi, '18f');
  
  return transformed;
}

async function fetchRandomCaption(sub, topCount = 20, maxLength = 25) {
  try {
    const response = await fetch(`https://www.reddit.com/r/${sub}/hot.json?limit=${topCount}`);
    const data = await response.json();
    
    if (data?.data?.children) {
      // Filter posts with titles under maxLength characters
      const validPosts = data.data.children.filter(post => 
        post.data.title && post.data.title.length < maxLength
      );
      
      if (validPosts.length > 0) {
        const randomPost = validPosts[Math.floor(Math.random() * validPosts.length)];
        return randomPost.data.title;
      }
    }
    return null;
  } catch (error) {
    console.error('Error fetching caption:', error);
    return null;
  }
}
  //==================================================================================END of Combo SAP===============================================================================
  
async function checkViaIframe(username) {
  return new Promise((resolve) => {
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.style.position = 'absolute';
    iframe.style.width = '0';
    iframe.style.height = '0';
    
    let resolved = false;
    const cleanup = () => {
      if (iframe.parentNode) document.body.removeChild(iframe);
    };
    const resolveOnce = (status) => {
      if (!resolved) {
        resolved = true;
        cleanup();
        resolve(status);
      }
    };
    
    iframe.onload = () => {
      try {
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        const bodyText = iframeDoc.body ? iframeDoc.body.innerText.toLowerCase() : '';
        if (bodyText.includes('banned') || bodyText.includes('suspended') || bodyText.includes('this account has been')) resolveOnce('banned');
        else if (bodyText.includes('nobody on reddit goes by that name') || bodyText.includes('page not found')) resolveOnce('notfound');
        else if (bodyText.length > 100) resolveOnce('active');
        else resolveOnce('error');
      } catch (e) {
        resolveOnce('error');
      }
    };
    iframe.onerror = () => resolveOnce('error');
    setTimeout(() => resolveOnce('error'), 5000);
    document.body.appendChild(iframe);
    iframe.src = `https://www.reddit.com/user/${username}`;
  });
}

async function updateSaveButtonColor() {
  const username = document.getElementById('profileUser').value.trim();
  const saveBtn = document.getElementById('saveProfileBtn');
  if (!username) {
    saveBtn.style.backgroundColor = 'var(--accent-orange)';
    saveBtn.style.border = 'none';
    saveBtn.style.color = '#000';
    document.getElementById('postCount').textContent = '0';
    return;
  }
  const status = await checkRedditUsername(username);
  switch(status) {
    case 'active':
      saveBtn.style.backgroundColor = '#2e7d32';
      saveBtn.style.border = 'none';
      saveBtn.style.color = 'white';
      break;
    case 'banned':
      saveBtn.style.backgroundColor = '#d32f2f';
      saveBtn.style.border = 'none';
      saveBtn.style.color = 'white';
      break;
    case 'notfound':
      saveBtn.style.backgroundColor = 'var(--accent-orange)';
      saveBtn.style.border = 'none';
      saveBtn.style.color = '#000';
      break;
    default:
      saveBtn.style.backgroundColor = 'var(--accent-orange)';
      saveBtn.style.border = 'none';
      saveBtn.style.color = '#000';
  }
  await updatePostCount(username);
}

async function updatePostCount(username) {
  if (!username || username.trim() === '') {
    document.getElementById('postCount').textContent = '0';
    document.getElementById('filteredCount').textContent = '0';
    return;
  }
  try {
    const response = await fetch(`https://www.reddit.com/user/${username.trim()}.json?limit=100`);
    if (!response.ok) {
      document.getElementById('postCount').textContent = '0';
      document.getElementById('filteredCount').textContent = '0';
      return;
    }
    const data = await response.json();
    if (data && data.data && data.data.children) {
      let activeCount = 0;
      let filteredCount = 0;
      data.data.children.forEach(post => {
        const postData = post.data;
        if (postData.removed_by_category || postData.spam || postData.banned_by || postData.removed || postData.author === '[deleted]' || postData.selftext === '[removed]') {
          filteredCount++;
        } else {
          activeCount++;
        }
      });
      document.getElementById('postCount').textContent = activeCount.toString();
      document.getElementById('filteredCount').textContent = filteredCount.toString();
    } else {
      document.getElementById('postCount').textContent = '0';
      document.getElementById('filteredCount').textContent = '0';
    }
  } catch (error) {
    console.error('Error fetching post count:', error);
    document.getElementById('postCount').textContent = '0';
    document.getElementById('filteredCount').textContent = '0';
  }
}

function startUsernameChecker() {
  if (usernameCheckInterval) clearInterval(usernameCheckInterval);
  updateSaveButtonColor();
  usernameCheckInterval = setInterval(() => {
    updateSaveButtonColor();
  }, 5000);
}

function stopUsernameChecker() {
  if (usernameCheckInterval) {
    clearInterval(usernameCheckInterval);
    usernameCheckInterval = null;
  }
}

document.addEventListener('DOMContentLoaded', function() {
  const usernameInput = document.getElementById('profileUser');
  if (usernameInput) {
    usernameInput.addEventListener('input', function() {
      updateSaveButtonColor();
    });
  }
});

function toggleCard(type) {
  const content = document.getElementById(type + 'Content');
  const icon = document.getElementById(type + 'Icon');
  content.classList.toggle('open');
  icon.classList.toggle('open');
}

async function loadFromSheet() {
  try {
    const resp = await fetch(SHEET_URL + "?action=readAll&t=" + Date.now());
    const data = await resp.json();
    const sheet1 = data.sheet1 || [];
    
    // Load existing data
    captions = sheet1.slice(1).map(row => row[4]).filter(Boolean);
    randomSubList = sheet1.slice(1).map(row => row[5]).filter(Boolean);
    testSubs = sheet1.slice(1).map(row => row[6]).filter(Boolean);
    
    // Load new data from columns H, I, J, K
    dmTexts = data.dmTexts || [];
    names = data.names || [];
    ofLines = data.ofLines || [];
    linkUrls = data.linkUrls || [];
    
    const sheet2 = data.sheet2 || [];
    if (sheet2.length < 1) throw new Error("Sheet2 empty");
    const headers = sheet2[0];
    locations = {};
    headers.forEach((loc, colIdx) => {
      if (loc && typeof loc === 'string' && loc.trim()) {
        const locSubs = [];
        for (let r = 1; r < sheet2.length; r++) {
          const val = sheet2[r][colIdx];
          if (val && typeof val === 'string' && val.trim()) locSubs.push(val.trim());
        }
        if (locSubs.length > 0) locations[loc.trim()] = locSubs;
      }
    });
    
    // Fallback to localStorage if data is empty
    if (Object.keys(locations).length === 0) locations = JSON.parse(localStorage.getItem('locations3') || '{}');
    if (captions.length === 0) captions = JSON.parse(localStorage.getItem('caps3') || '[]');
    if (testSubs.length === 0) testSubs = JSON.parse(localStorage.getItem('testSubs3') || '[]');
    if (dmTexts.length === 0) dmTexts = ["I'm new here, come take a peek at my page below and enjoy a little surprise I left for you"];
    if (names.length === 0) names = ["Sophyy üå∏"];
    if (ofLines.length === 0) ofLines = ["OF (nudes&dms)üòú"];
    if (linkUrls.length === 0) linkUrls = ["https://tapformysocials.me/girlygirl"];
    
    populateLocationSelect();
    selectLocation(currentLocation || Object.keys(locations)[0] || '');
    render('testList', testSubs, testChecked);
    render('captionList', captions, capUsed);
    updateStats();
    showToast(`‚úÖ Loaded ‚Äì ${Object.keys(locations).length} locations`);
  } catch (e) {
    console.error(e);
    locations = JSON.parse(localStorage.getItem('locations3') || '{}');
    captions = JSON.parse(localStorage.getItem('caps3') || '[]');
    testSubs = JSON.parse(localStorage.getItem('testSubs3') || '[]');
    
    // Set fallback values
    if (dmTexts.length === 0) dmTexts = ["I'm new here, come take a peek at my page below and enjoy a little surprise I left for you"];
    if (names.length === 0) names = ["Sophyy üå∏"];
    if (ofLines.length === 0) ofLines = ["OF (nudes&dms)üòú"];
    if (linkUrls.length === 0) linkUrls = ["https://tapformysocials.me/girlygirl"];
    
    populateLocationSelect();
    selectLocation(currentLocation || Object.keys(locations)[0] || '');
    render('testList', testSubs, testChecked);
    render('captionList', captions, capUsed);
    updateStats();
    showToast("‚ö†Ô∏è Offline ‚Äì using local data");
  }
}

function populateLocationSelect() {
  const select = document.getElementById('locationSelect');
  select.innerHTML = '<option value="">-- Select Location --</option>';
  Object.keys(locations).sort().forEach(loc => {
    const opt = document.createElement('option');
    opt.value = loc;
    opt.textContent = loc;
    select.appendChild(opt);
  });
  select.onchange = () => selectLocation(select.value);
}

function selectLocation(locName) {
  if (!locName || !locations[locName]) {
    subs = [];
    currentLocation = '';
  } else {
    subs = locations[locName];
    currentLocation = locName;
    const keyPrefix = 'loc_' + btoa(locName).replace(/=/g,'');
    subChecked = JSON.parse(localStorage.getItem(keyPrefix + '_ch') || '{}');
    subIndex = parseInt(localStorage.getItem(keyPrefix + '_idx') || '0');
  }
  localStorage.setItem('currentLocation', currentLocation);
  document.getElementById('locationSelect').value = currentLocation;
  render('subList', subs, subChecked);
  updateStats();
}

const save = () => {
  localStorage.setItem('locations3', JSON.stringify(locations));
  localStorage.setItem('caps3', JSON.stringify(captions));
  localStorage.setItem('capUs3', JSON.stringify(capUsed));
  localStorage.setItem('testSubs3', JSON.stringify(testSubs));
  localStorage.setItem('testCh3', JSON.stringify(testChecked));
  localStorage.setItem('testIdx3', testIndex);
  localStorage.setItem('dmUsed', JSON.stringify(dmUsed));
  localStorage.setItem('nameUsed', JSON.stringify(nameUsed));
  localStorage.setItem('ofUsed', JSON.stringify(ofUsed));
  localStorage.setItem('currentLocation', currentLocation);
  if (currentLocation) {
    const keyPrefix = 'loc_' + btoa(currentLocation).replace(/=/g,'');
    localStorage.setItem(keyPrefix + '_ch', JSON.stringify(subChecked));
    localStorage.setItem(keyPrefix + '_idx', subIndex);
  }
  localStorage.setItem('subCh3', JSON.stringify(subChecked));
  localStorage.setItem('subIdx3', subIndex);
};

let baseIP = localStorage.getItem('selectedBaseIP') || '192.168.1';
function updateToggleButton() {
  const btn = document.getElementById('ipToggle');
  if (baseIP === '192.168.1') {
    btn.textContent = '192.168.1.x';
    btn.classList.remove('active');
  } else {
    btn.textContent = 'FULL IP MODE';
    btn.classList.add('active');
  }
}
document.getElementById('ipToggle').onclick = () => {
  baseIP = baseIP === '192.168.1' ? 'FULL' : '192.168.1';
  localStorage.setItem('selectedBaseIP', baseIP);
  updateToggleButton();
  showToast(baseIP === 'FULL' ? 'üåê Full IP mode' : 'üè† Local IP mode');
};
function triggerLua() {
  const input = document.getElementById("ipInput").value.trim();
  if (!input) return;
  let finalIP;
  if (baseIP === '192.168.1') {
    if (isNaN(input)) return;
    finalIP = `192.168.1.${input}`;
  } else {
    finalIP = input;
  }
  const url = `http://${finalIP}:8080/control/start_playing?path=/test.lua&t=${Date.now()}`;
  new Image().src = url;
  showToast(`‚úÖ Triggered: ${finalIP}`);
}
updateToggleButton();

const render = (id, data, used) => {
  const ul = document.getElementById(id);
  ul.innerHTML = '';
  data.forEach((item, i) => {
    const div = document.createElement('div');
    div.className = 'list-item' + (used[item] ? ' checked' : '');
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = !!used[item];
    checkbox.onchange = () => { 
      used[item] = !used[item]; 
      save(); 
      render(id, data, used); 
      updateStats(); 
    };
    const text = document.createElement('div');
    text.className = 'list-item-text';
    text.textContent = item;
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'list-item-delete';
    deleteBtn.textContent = '√ó';
    deleteBtn.onclick = () => {
      if(confirm('Delete this item?')) {
        data.splice(i, 1);
        delete used[item];
        if (id === 'subList') updateLocationsAfterDelete();
        save();
        render(id, data, used);
        updateStats();
      }
    };
    div.appendChild(checkbox);
    div.appendChild(text);
    div.appendChild(deleteBtn);
    ul.appendChild(div);
  });
};

function updateLocationsAfterDelete() {
  if (currentLocation) locations[currentLocation] = subs;
}

const updateStats = () => {
  document.getElementById('subCount').textContent = subs.length;
  document.getElementById('subDone').textContent = Object.values(subChecked).filter(v=>v).length;
  document.getElementById('subBadge').textContent = `${Object.values(subChecked).filter(v=>v).length}/${subs.length}`;
  document.getElementById('testCount').textContent = testSubs.length;
  document.getElementById('testDone').textContent = Object.values(testChecked).filter(v=>v).length;
  document.getElementById('testBadge').textContent = `${Object.values(testChecked).filter(v=>v).length}/${testSubs.length}`;
  document.getElementById('capCount').textContent = captions.length;
  document.getElementById('capUsed').textContent = Object.values(capUsed).filter(v=>v).length;
  document.getElementById('capBadge').textContent = `${Object.values(capUsed).filter(v=>v).length}/${captions.length}`;
  updateIPHeader();
};

document.getElementById('subrReset').onclick = () => { 
  if(confirm("Reset progress for current location?")) { 
    subChecked = {}; 
    subIndex = 0; 
    save(); 
    render('subList', subs, subChecked); 
    updateStats(); 
  }
};

document.getElementById('captionReset').onclick = () => { 
  if(confirm("Reset all captions?")) { 
    capUsed = {}; 
    save(); 
    render('captionList', captions, capUsed); 
    updateStats(); 
  }
};

document.getElementById('testReset').onclick = () => { 
  if(confirm("Reset test subs progress?")) { 
    testChecked = {}; 
    testIndex = 0; 
    save(); 
    render('testList', testSubs, testChecked); 
    updateStats(); 
  }
};

document.getElementById('toggleSub').onclick = () => { 
  const l = document.getElementById('subList'); 
  l.classList.toggle('hidden');
};

document.getElementById('toggleCap').onclick = () => { 
  const l = document.getElementById('captionList'); 
  l.classList.toggle('hidden');
};

document.getElementById('toggleTest').onclick = () => { 
  const l = document.getElementById('testList'); 
  l.classList.toggle('hidden');
};

document.getElementById('addSubBtn').onclick = (e) => { 
  e.stopPropagation(); 
  if (!currentLocation) return alert("Select a location first!");
  const input = prompt("Add subreddits (one per line, no r/):"); 
  if (!input) return; 
  const lines = input.split('\n').map(l => l.trim()).filter(l => l); 
  let added = 0; 
  lines.forEach(sub => { 
    if (sub && !subs.includes(sub)) { 
      subs.push(sub); 
      added++; 
    } 
  }); 
  if (added > 0) { 
    locations[currentLocation] = subs; 
    save(); 
    render('subList', subs, subChecked); 
    updateStats(); 
    showToast(`‚úÖ Added ${added} to ${currentLocation}`); 
  } 
};

document.getElementById('addTestBtn').onclick = (e) => { 
  e.stopPropagation(); 
  const input = prompt("Add test subreddits (one per line, no r/):"); 
  if (!input) return; 
  const lines = input.split('\n').map(l => l.trim()).filter(l => l); 
  let added = 0; 
  lines.forEach(sub => { 
    if (sub && !testSubs.includes(sub)) { 
      testSubs.push(sub); 
      added++; 
    } 
  }); 
  if (added > 0) { 
    save(); 
    render('testList', testSubs, testChecked); 
    updateStats(); 
    showToast(`‚úÖ Added ${added} test sub${added > 1 ? 's' : ''}`); 
  } 
};

document.getElementById('addCapBtn').onclick = (e) => { 
  e.stopPropagation(); 
  const input = prompt("Add captions (one per line):"); 
  if (!input) return; 
  const lines = input.split('\n').map(l => l.trim()).filter(l => l); 
  let added = 0; 
  lines.forEach(cap => { 
    if (cap && !captions.includes(cap)) { 
      captions.push(cap); 
      added++; 
    } 
  }); 
  if (added > 0) { 
    save(); 
    render('captionList', captions, capUsed); 
    updateStats(); 
    showToast(`‚úÖ Added ${added} caption${added > 1 ? 's' : ''}`); 
  } 
};

document.getElementById('subRefresh').onclick = () => loadFromSheet();

function updateCaptionsNow() { 
  localStorage.removeItem('caps3'); 
  localStorage.removeItem('capUs3'); 
  location.reload(); 
}

let userIP = '', previousIP = '', scamalyticsWindow = null;

function updateIPHeader() { 
  const ip = document.getElementById('ip').textContent; 
  document.getElementById('ipHeader').textContent = (ip && ip !== 'Loading...' && !ip.includes('Failed') && !ip.includes('Offline')) ? ip : 'No IP'; 
}

fetch('https://api.ipify.org?format=json')
  .then(r => r.json())
  .then(d => { 
    userIP = d.ip; 
    document.getElementById("ip").textContent = userIP; 
    updateIPHeader(); 
    fetchIPLocation(userIP);
  })
  .catch(() => { 
    document.getElementById("ip").textContent = "Offline";
    document.getElementById("ipLocation").textContent = "‚Äî";
    updateIPHeader(); 
  });

function rotateIP() { 
  const btn = event.target;
  const url = document.getElementById("rotateLink").value.trim(); 
  if (!url) return alert("Enter rotation URL"); 
  btn.disabled = true; 
  btn.innerHTML = "‚è≥ Starting..."; 
  new Image().src = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now(); 
  let s = 8; 
  const timer = setInterval(() => { 
    s--; 
    btn.innerHTML = s > 0 ? `‚è≥ ${s}s...` : "‚úÖ Done!"; 
    if (s <= 0) clearInterval(timer); 
  }, 1000); 
  setTimeout(() => { 
    btn.innerHTML = "üîÑ Rotate"; 
    btn.disabled = false; 
    showToast("üîÑ Rotation triggered!"); 
  }, 8500); 
}

// Save rotate link when user types
document.getElementById('rotateLink').addEventListener('input', function() {
  localStorage.setItem('rotateLink', this.value);
});

// Also save when user pastes
document.getElementById('rotateLink').addEventListener('paste', function() {
  setTimeout(() => {
    localStorage.setItem('rotateLink', this.value);
  }, 10);
});

function refreshAndOpen() { 
  const btn = event.target;
  btn.disabled = true; 
  btn.innerHTML = "‚è≥ Loading..."; 
  if (!scamalyticsWindow || scamalyticsWindow.closed) {
    scamalyticsWindow = window.open('about:blank', '_blank'); 
  }
  fetch('https://api.ipify.org?format=json')
    .then(r => r.json())
    .then(d => { 
      if(userIP) { 
        previousIP = userIP; 
        document.getElementById("oldIP").textContent = previousIP; 
      } 
      userIP = d.ip; 
      document.getElementById("ip").textContent = userIP; 
      updateIPHeader(); 
      fetchIPLocation(userIP);
      scamalyticsWindow.location.href = `https://scamalytics.com/ip/${userIP}`; 
      btn.style.backgroundColor = (previousIP && previousIP !== userIP) ? "#2e7d32" : "#d32f2f"; 
      btn.innerHTML = (previousIP && previousIP !== userIP) ? "‚úÖ Changed!" : "‚ö†Ô∏è No Change"; 
    })
    .catch(() => { 
      btn.style.backgroundColor = "#b71c1c"; 
      btn.innerHTML = "‚ùå Failed"; 
    })
    .finally(() => { 
      btn.disabled = false; 
    }); 
}

function showToast(m) { 
  const t = document.getElementById('toast'); 
  t.textContent = m; 
  t.classList.add('show'); 
  clearTimeout(t.timeout); 
  t.timeout = setTimeout(() => t.classList.remove('show'), 2000); 
}

const randomNoRepeat = (arr, used) => {
  const unused = arr.filter(x => !used[x]);
  if(unused.length === 0) { 
    Object.keys(used).forEach(k => delete used[k]); 
    save(); 
    showToast("üîÑ Reset!"); 
    return randomNoRepeat(arr, used); 
  }
  const pick = unused[Math.floor(Math.random() * unused.length)];
  navigator.clipboard.writeText(pick); 
  used[pick] = true; 
  save(); 
  triggerLua();
  showToast("üìã Copied!");
};

document.getElementById('fabD').onclick = () => randomNoRepeat(dmTexts, dmUsed);
document.getElementById('fabN').onclick = () => randomNoRepeat(names, nameUsed);
document.getElementById('fabOF').onclick = () => randomNoRepeat(ofLines, ofUsed);
document.getElementById('fabLink').onclick = () => {
  if (linkUrls.length === 0) return showToast("‚ö†Ô∏è No links available");
  const link = linkUrls[Math.floor(Math.random() * linkUrls.length)];
  navigator.clipboard.writeText(link); 
  showToast("üîó Link copied"); 
};

document.getElementById('randomSubBtn').onclick = () => {
  if (randomSubList.length === 0) return showToast("‚ö†Ô∏è No warming subs");
  const random = randomSubList[Math.floor(Math.random() * randomSubList.length)];
  const appUrl = "reddit://reddit.com/r/" + random;
  
  window.location.href = appUrl;

  showToast("üé≤ Opening r/" + random);
};

async function fetchRandomCaptionForSAP(subreddit) {
  try {
    const response = await fetch(`https://www.reddit.com/r/${subreddit}/hot.json?limit=50`);
    if (!response.ok) throw new Error('Subreddit not found');
    const data = await response.json();
    const posts = data.data.children;
    if (posts.length === 0) throw new Error('No posts found');
    const titles = posts.filter(post => !post.data.stickied).map(post => post.data.title);
    if (titles.length === 0) throw new Error('No suitable posts');
    return titles[Math.floor(Math.random() * titles.length)];
  } catch (error) {
    console.error('Error fetching caption:', error);
    return null;
  }
}

document.getElementById('comboFab').onclick = async () => {
  if (!currentLocation || subs.length === 0) return showToast("‚ö†Ô∏è Select a location with subs!");
  
  let sub = ''; 
  let startIndex = subIndex;
  do { 
    sub = subs[subIndex]; 
    if (!subChecked[sub]) break; 
    subIndex = (subIndex + 1) % subs.length; 
  } while (subIndex !== startIndex);
  
  if (subChecked[sub]) { 
    subChecked = {}; 
    subIndex = 0; 
    save(); 
    showToast("üîÑ All used in " + currentLocation + " ‚Üí Reset!"); 
  }
  
  subChecked[sub] = true; 
  subIndex = (subIndex + 1) % subs.length; 
  save();
  
  // Fetch caption from the subreddit
  let caption = await fetchRandomCaptionForSAP(sub);
  
  // Fallback to local captions if fetch fails
  if (!caption) {
    showToast("‚ö†Ô∏è Fetch failed, using local caption");
    const unusedCaps = captions.filter(c => !capUsed[c]);
    if (unusedCaps.length === 0) { 
      capUsed = {}; 
      save(); 
    }
    caption = unusedCaps.length ? unusedCaps[Math.floor(Math.random() * unusedCaps.length)] : captions[Math.floor(Math.random() * captions.length)];
    capUsed[caption] = true; 
    save();
  }
  
  const encodedTitle = encodeURIComponent(caption.trim());
  const redditUrl = `https://www.reddit.com/r/${sub}/submit?title=${encodedTitle}`;
  window.location.href = redditUrl;
  
  render('subList', subs, subChecked); 
  render('captionList', captions, capUsed); 
  updateStats();
  navigator.clipboard.writeText(sub); 
  showToast(`üöÄ SAP ‚Üí r/${sub} (${currentLocation})`);
};

document.getElementById('testComboFab').onclick = () => {
  if (testSubs.length === 0) return showToast("‚ö†Ô∏è No test subs!");
  let sub = ''; 
  let startIndex = testIndex;
  do { 
    sub = testSubs[testIndex]; 
    if (!testChecked[sub]) break; 
    testIndex = (testIndex + 1) % testSubs.length; 
  } while (testIndex !== startIndex);
  if (testChecked[sub]) { 
    testChecked = {}; 
    testIndex = 0; 
    save(); 
    showToast("üîÑ All test used ‚Üí Reset!"); 
  }
  testChecked[sub] = true; 
  testIndex = (testIndex + 1) % testSubs.length; 
  save();
  const unusedCaps = captions.filter(c => !capUsed[c]);
  if (unusedCaps.length === 0) { 
    capUsed = {}; 
    save(); 
    showToast("üîÑ Captions reset!"); 
  }
  const caption = unusedCaps.length ? unusedCaps[Math.floor(Math.random() * unusedCaps.length)] : captions[Math.floor(Math.random() * captions.length)];
  capUsed[caption] = true; 
  save();
  const encodedTitle = encodeURIComponent(caption.trim());
  const redditUrl = `https://www.reddit.com/r/${sub}/submit?title=${encodedTitle}`;
  window.open(redditUrl, '_blank');
  render('testList', testSubs, testChecked); 
  render('captionList', captions, capUsed); 
  updateStats();
  navigator.clipboard.writeText(sub); 
  showToast(`üß™ Test ‚Üí r/${sub}`);
};

let profileData = []; 
let currentRow = 2; 
let currentIndex = parseInt(localStorage.getItem('lastProfileIndex') || '0');

function loadProfiles() { 
  fetch(PROFILE_URL + "?action=read&t=" + Date.now())
    .then(r => r.json())
    .then(d => { 
      profileData = d.values || []; 
      if (profileData.length === 0) { 
        showToast("‚ö†Ô∏è Profile sheet is empty"); 
        clearProfileFields(); 
      } else { 
        // Always load the latest profile (last item in array)
        currentIndex = profileData.length - 1;
        localStorage.setItem('lastProfileIndex', currentIndex);
        loadProfile(currentIndex); 
        showToast(`üë§ Latest profile loaded (${currentIndex + 1}/${profileData.length})`); 
      } 
    })
    .catch(() => showToast("‚ö†Ô∏è Profile sheet offline")); 
}

function clearProfileFields() { 
  document.getElementById('profileName').value = ''; 
  document.getElementById('profilePass').value = ''; 
  document.getElementById('profileUser').value = ''; 
  document.getElementById('profileID').value = ''; 
}

function loadProfile(index) { 
  if (profileData.length === 0) return; 
  if (index < 0) index = 0; 
  if (index >= profileData.length) index = profileData.length - 1; 
  const row = profileData[index]; 
  document.getElementById('profileName').value = row[0] || ''; 
  document.getElementById('profilePass').value = row[1] || ''; 
  document.getElementById('profileUser').value = row[2] || ''; 
  document.getElementById('profileID').value = row[3] || ''; 
  currentRow = index + 2; 
  currentIndex = index; 
  localStorage.setItem('lastProfileIndex', index); 
}

function prevProfile() { 
  loadProfile(currentIndex - 1); 
}

function nextProfile() { 
  loadProfile(currentIndex + 1); 
}

function generatePassword() {
  if (document.getElementById('profilePass').value !== '') {
    return showToast("‚ö†Ô∏è Password field not empty");
  }
  const words = ["cat", "dog", "sun", "sky", "sea", "pen", "cup", "hat", "map", "run", "walk", "talk", "play", "read", "book", "tree", "rock", "sand", "wind", "rain", "fire", "snow", "moon", "star", "blue", "pink", "gold", "gray", "warm", "cool", "fast", "slow", "jump", "stop", "move", "push", "pull", "hold", "open", "shut", "time", "hour", "day", "week", "year", "life", "love", "hope", "calm", "kind"];
  const specialChars = "!@#$%^&*";
  
  // Pick 1 random word
  const randomWord = words[Math.floor(Math.random() * words.length)];
  
  // Generate 5 random numbers
  let randomNumbers = "";
  for (let i = 0; i < 5; i++) {
    randomNumbers += Math.floor(Math.random() * 10);
  }
  
  // Pick 1 random special character
  const randomSpecial = specialChars[Math.floor(Math.random() * specialChars.length)];
  
  // Combine everything
  const finalPassword = "reddit" + randomWord + randomNumbers + randomSpecial;
  
  document.getElementById('profilePass').value = finalPassword;
  copyText('profilePass');
  showToast(`üîë Generated & copied!`);
}

async function pasteUsername() { 
  try { 
    const text = await navigator.clipboard.readText(); 
    document.getElementById('profileUser').value = text.trim(); 
    showToast("üìã Username pasted"); 
  } catch { 
    showToast("‚ö†Ô∏è Paste failed (allow clipboard)"); 
  } 
}

function saveProfile() { 
  const pass = document.getElementById('profilePass').value.trim(); 
  const user = document.getElementById('profileUser').value.trim(); 
  if (!pass || !user) return showToast("‚ö†Ô∏è Fill Password & Username"); 
  fetch(`${PROFILE_URL}?action=write&row=${currentRow}&pass=${encodeURIComponent(pass)}&user=${encodeURIComponent(user)}&t=${Date.now()}`)
    .then(r => r.json())
    .then(() => { 
      showToast("‚úÖ Saved to sheet"); 
      profileData[currentIndex][1] = pass; 
      profileData[currentIndex][2] = user; 
    })
    .catch(() => showToast("‚ùå Save failed")); 
}

function copyText(id) { 
  const el = document.getElementById(id); 
  el.focus(); 
  el.select(); 
  navigator.clipboard.writeText(el.value); 
  showToast("üìã " + (el.placeholder || el.id) + " copied"); 
}

function fetchIPLocation(ip) {
  fetch(`https://ipapi.co/${ip}/json/`)
    .then(r => r.json())
    .then(data => {
      if (data.error) throw new Error('ipapi.co failed');
      let location = '';
      if (data.city && data.region && data.country_name) {
        location = `${data.city}, ${data.region}, ${data.country_name}`;
      } else if (data.region && data.country_name) {
        location = `${data.region}, ${data.country_name}`;
      } else if (data.country_name) {
        location = data.country_name;
      }
      document.getElementById("ipLocation").textContent = location || "Location unknown";
    })
    .catch(() => {
      fetch(`http://ip-api.com/json/${ip}?fields=status,city,regionName,country`)
        .then(r => r.json())
        .then(data => {
          if (data.status === 'success') {
            let location = '';
            if (data.city && data.regionName && data.country) {
              location = `${data.city}, ${data.regionName}, ${data.country}`;
            } else if (data.regionName && data.country) {
              location = `${data.regionName}, ${data.country}`;
            } else if (data.country) {
              location = data.country;
            }
            document.getElementById("ipLocation").textContent = location || "Location unknown";
          } else {
            document.getElementById("ipLocation").textContent = "Location unavailable";
          }
        })
        .catch(() => {
          document.getElementById("ipLocation").textContent = "Location unavailable";
        });
    });
}

document.getElementById('fabCreate').onclick = () => { 
  const currentID = document.getElementById('profileID').value.trim(); 
  if (!currentID) { 
    showToast("‚ö†Ô∏è No ID loaded"); 
    return; 
  } 
  navigator.clipboard.writeText(currentID); 
  window.location.href = "shortcuts://run-shortcut?name=CreateRed"; 
  showToast("üöÄ ID copied ‚Üí CreateRed launched"); 
};

document.getElementById('fabUrl').onclick = () => {
  const currentUrl = localStorage.getItem('sheetURL') || SHEET_URL;
  const newUrl = prompt('Edit Google Sheet URL:', currentUrl);
  
  if (newUrl && newUrl.trim() !== '') {
    const trimmedUrl = newUrl.trim();
    localStorage.setItem('sheetURL', trimmedUrl);
    SHEET_URL = trimmedUrl;
    PROFILE_URL = trimmedUrl;
    showToast('‚úÖ URL saved!');
  } else if (newUrl === '') {
    showToast('‚ö†Ô∏è URL cannot be empty');
  }
};

window.addEventListener('load', () => {
  updateToggleButton();
  updateIPHeader();
  loadFromSheet();
  loadProfiles();
  startUsernameChecker();
  
  // Load saved rotate link
  const savedRotateLink = localStorage.getItem('rotateLink');
  if (savedRotateLink) {
    document.getElementById('rotateLink').value = savedRotateLink;
  }
});

window.addEventListener('beforeunload', () => {
  stopUsernameChecker();
});
</script>
</body>
</html>
